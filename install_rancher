#!/bin/bash

RANCHER_VERSION='v0.6.7'
RANCHER_REPO='https://github.com/rancher/cli'
CURRENT_DISTRO=$(uname -s)
RANCHER_CONTAINER='rancher'
RANCHER_PORT='9595'
INSTALL_PYTHON=false

case "${CURRENT_DISTRO}" in
    Linux*)
        DISTRO_TYPE='linux'
        RANCHER_DISTRO='rancher-linux-amd64';;
    Darwin*)
        DISTRO_TYPE='unix'
        RANCHER_DISTRO='rancher-darwin-amd64';;
    CYGWIN*)
        DISTRO_TYPE='windows'
        RANCHER_DISTRO='rancher-windows-amd64';;
    MINGW*)
        DISTRO_TYPE='windows'
        RANCHER_DISTRO='rancher-windows-amd64';;
    *)
        echo 'Error: distro is not known, contact repository owner.'
        exit 1
esac

## download rancher-cli
if [ "$DISTRO_TYPE" = 'unix' ]; then
    curl -OL "$RANCHER_REPO/releases/download/$RANCHER_VERSION/$RANCHER_DISTRO-$RANCHER_VERSION.tar.gz"
    tar zxf "$RANCHER_DISTRO-$RANCHER_VERSION.tar.gz"
    rm "$RANCHER_DISTRO-$RANCHER_VERSION.tar.gz"
    sudo mv rancher-v"$RANCHER_VERSION"/rancher /usr/local/bin/rancher
    sudo chmod +x /usr/local/bin/rancher

elif [ "$DISTRO_TYPE" = 'linux' ]; then
    if [ ! which curl ]; then
        sudo apt-get -y install curl || sudo yum -y install curl || (echo 'curl cannot install' && exit 1)
    fi

    curl -OL "$RANCHER_REPO/releases/download/$RANCHER_VERSION/$RANCHER_DISTRO-$RANCHER_VERSION.tar.gz"
    tar zxf "$RANCHER_DISTRO-$RANCHER_VERSION.tar.gz"
    rm "$RANCHER_DISTRO-$RANCHER_VERSION.tar.gz"
    sudo mv rancher-v"$RANCHER_VERSION"/rancher /usr/local/bin/rancher
    sudo chmod +x /usr/local/bin/rancher

elif [ "$DISTRO_TYPE" = 'windows' ]; then
    curl -OL "$RANCHER_REPO/releases/download/$RANCHER_VERSION/$RANCHER_DISTRO-$RANCHER_VERSION.zip"
    unzip -j "$RANCHER_DISTRO-$RANCHER_VERSION"
    mkdir -p /c/programdata/rancher/bin
    mv -f rancher.exe /c/programdata/rancher/bin
    rm "$RANCHER_DISTRO-$RANCHER_VERSION.zip"

    ## install python
    command -v python >/dev/null 2>&1 || INSTALL_PYTHON=true
    if [[ $CURRENT_DISTRO == MINGW* ]] && [[ $INSTALL_PYTHON ]]; then
        PYTHON_VERSION_FULL='3.6.4'
        PYTHON_VERSION=$(echo ${PYTHON_VERSION_FULL%.*} | tr --delete .)

        while [[ "$INSTALL_PYTHON" != 'y' ]] && [[ "$INSTALL_PYTHON" != 'n' ]]
        do
            echo "Windows (MINGW*) installation for rancher-cli, depends on"
            echo "'choco', and 'python'."
            echo ''
            echo '[Y]: install'
            echo '[N]: do not install'
            echo ''
            read -p 'Proceed with installation: ' INSTALL_PYTHON
        done

        if [ "${INSTALL_PYTHON,,}" = 'y' ]; then
            powershell.exe -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "
                iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
            "

            ## successive processes
            setx PATH "$env:path;C:/programdata/chocolatey/bin;C:/programdata/rancher/bin;C:/python$PYTHON_VERSION"

            ## current process
            PATH="$PATH:/c/programdata/chocolatey/bin:/c/programdata/rancher/bin:/c/python$PYTHON_VERSION"

            ## install python
            choco install -f python --version "$PYTHON_VERSION_FULL"

        else
            echo 'terminating rancher installation...'
            exit 0
        fi
    fi

else
    echo 'Error: distro is not known, contact repository owner.'
    exit 1
fi

## install rancher ecosystem
if docker -v >/dev/null 2>&1; then
    if [ "$(docker ps -a | grep $RANCHER_CONTAINER)" ]; then
        docker kill "$RANCHER_CONTAINER"
        docker rm "$RANCHER_CONTAINER"
    fi

    docker run -d --name "$RANCHER_CONTAINER" --restart=unless-stopped -p 8080:"$RANCHER_PORT" rancher/server

    mkdir -p ~/.rancher
    mkdir -p ./docker_storage_redis
    mkdir -p ./docker_storage_mongodb
    mkdir -p ./docker_storage_mariadb

    SERVER_IP=$(docker-machine ip default)

    ## generate access + secret key:
    ##
    ## Note: exporting environment eliminates the need to explicitly provide
    ##       environment variable explicitly to 'rancher' command.
    ##
    ## Note: 'curl' response for ACCESS is json:
    ##
    ##     https://github.com/rancher/rancher/issues/4961#issuecomment-222598633
    ##
    ACCESS=$(
        curl -v -X POST -H 'Accept: application/json' \
        -H 'Content-Type: application/json' \
        -d '{"type":"apikey","accountId":"1a1","name":"admin","description":null,"created":null,"kind":null,"removed":null,"uuid":null}' \
        http://"$SERVER_IP:$RANCHER_PORT"/v2-beta/apikeys
    )

    RANCHER_ACCESS_KEY=$(echo "$ACCESS" | python -c 'import json,sys;obj=json.load(sys.stdin);print(obj["name"])')
    RANCHER_SECRET_KEY=$(echo "$ACCESS" | python -c 'import json,sys;obj=json.load(sys.stdin);print(obj["secretValue"])')
    RANCHER_URL=http://"$SERVER_IP:$RANCHER_PORT"/
    echo '{"accessKey":"${RANCHER_ACCESS_KEY}","secretKey":"${RANCHER_SECRET_KEY}","url":"${RANCHER_URL}","environment":"1a5"}' > ~/.rancher/cli.json

    rancher stack create -f docker-compose.development -r rancher-compose.development --start
else
    echo 'please install docker per https://github.com/jeff1evesque/machine-learning#installation'
    exit 1
fi
