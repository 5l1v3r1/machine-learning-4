#!/bin/bash

# @sass: minify scss file(s).
#
# @$1, first passed-in argument from command ($0 is the filename)


# Pre-Pathing: allow 'sass' command
PATH="/usr/local/bin:$PATH"


# allow globstar, and extglob patterns
shopt -s globstar extglob


# track execution of script
log_file="$1"/log/webcompiler/sass.log
set -x;
exec &> >(while read -r line; do
  log_date=$(date +%Y-%m-%d:%H:%M:%S)
  printf "%s %s\n" "[$log_date]" "$line" >> "$log_file"
done)

# compile with 'node-sass'
node-sass "$1"/src/scss/style.scss "$1"/interface/static/css/style.min.css --output-style compressed
node-sass -w "$1"/src/scss/ -o "$1"/interface/static/css/ --output-style compressed

# ensure proper file extension: on initial build
#
# Note: the globstar, and extglob patterns are implemented
#
for file in "$1"/interface/static/css/**/!(*.min).css; do mv "$file" "${file/%css/min.css}"; done

# watch '[root_dir]/interface/static/css/' subdirectory
inotifywait "$1"/interface/static/css/ -m -r -e close_write -e move --format %f |

  # ensure proper file extension: on successive builds
  while read -r file; do

    if [[ "$file" != '*.min.css' ]]; then
      mv "$file" "${file/%css/min.css}"
    fi

  done
